#!/usr/bin/env ruby

require 'timeout'
require 'io/console'


if ARGV.length == 0
 puts "exec-on is a utility that receives piped input text and executes a"
 puts "command when given pattern is matched."
 puts "Usage: cat my.log | exec-on (regular expression) [command on match]"
 puts "If no command on match is specified, this utility will just highlight"
 puts "matched text on the shell."
 puts "If a command is specified on match, this utility will call the command"
 puts "and send it the line that matched the regular expression as its single"
 puts "input."
 exit(1)
end

class String
  def convert
    self.encode("UTF-8", :invalid => :replace, :undef => :replace, :replace => "?")
  end

  def remove_non_utf8
    convert[0..-2]
  end
end

# Highlights the line with a black background and yellow foreground
def highlight(line)
  "\e[1;33;40m#{line}\e[0m"
end

pattern=Regexp.new(ARGV.shift)
command = nil
command = ARGV.shift unless ARGV.first.nil?
ARGF.each_line do |line|
  line = line.remove_non_utf8
  if pattern.match line
    puts highlight line
    unless command.nil?
      begin
        system "#{command} '#{line}'"
      rescue
      end
    end
  else
    puts line
  end
end
