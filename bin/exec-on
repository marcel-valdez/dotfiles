#!/usr/bin/env ruby

require 'timeout'
require 'io/console'
require 'iconv'


if ARGV.length == 0
 puts "alert-on is a utility that receives piped input text and alerts when a"
 puts "given pattern is found."
 puts "Usage: cat my.log | alert-on (regular expression) [command on match]"
 puts "If no command on match is specified, this utility will try to execute 'echo' on the shell."
 puts "If a command is specified on match, this utility will call the command and send it"
 puts "the line that matched the regular expression as its single input."
 exit(1)
end

class String
  def converter
    if @converter.nil?
      @converter = Iconv.new('UTF-8//IGNORE', 'UTF-8')
    end

    @converter
  end

  def remove_non_utf8
    converter.iconv(self)[0..-2]
  end
end

def highlight(line)
"--------------------------------------------------------------------------------------------------------\n
#{line}
---------------------------------------------------------------------------------------------------------"
end

pattern=Regexp.new(ARGV.shift)
command = 'echo'
command = ARGV.shift unless ARGV.first.nil?
ARGF.each_line do |line|
  line = line.remove_non_utf8
  if pattern.match line
    puts highlight line
    begin
      system "#{command} '#{line}'"
    rescue
    end
  else
    puts line
  end
end
